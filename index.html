<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PWA for Gleecall">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Total Gleecall</title>

    <!-- WebApp Config Stuff-->
    <meta name="theme-color" content="#00a3e0">
    <link rel="apple-touch-icon" sizes="180x180" href="/gleecall.api/assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/gleecall.api/assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/gleecall.api/assets/favicon-16x16.png">
    <link rel="manifest" href="/gleecall.api/assets/site.webmanifest">
    <link rel="mask-icon" href="/gleecall.api/assets/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="/gleecall.api/assets/favicon.ico">
    <meta name="msapplication-TileColor" content="#c9dfee">
    <meta name="msapplication-config" content="/gleecall.api/assets/browserconfig.xml">
    <meta name="theme-color" content="#c9dfee">
    <style>
        /* app shell CSS */
        :root {
            --gray: rgb(236, 235, 235);
            --whitesmoke: #fff;
            --dark: #2F2F2F;
            --glee-blue: #c9dfee;
            --accent: rgb(174, 219, 250);
        }

        body {
            margin: 0;
            background-color: var(--whitesmoke);
            /* font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans",
                "Helvetica Neue", sans-serif; */
            font-family: Arial, Helvetica, sans-serif;
            overflow-x: auto;
            overflow-y: hidden;
        }

        #navbar {
            height: 116px;
            background-color: var(--glee-blue);
            z-index: 2;
            box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            color: var(--dark);
            font-size: 22px;
            font-weight: 600;
        }

        #navbar h2 {
            margin: auto;
        }

        #app-shell {
            width: 100vw;
            margin: 0;
        }

        #screens {
            display: flex;
            width: 100vw;
            margin: auto;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
        }

        .screen {
            flex: 0 0 50vw;
            height: calc(100vh - 116px);
            scroll-snap-align: start;
            overflow-y: auto;

            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #results {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        @media only screen and (max-width: 1000px) {
            .screen {
                flex: 0 0 100vw;
            }
        }

        .spinner-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .spinner {
            animation: rotator 1.4s linear infinite;
        }

        @keyframes rotator {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(270deg);
            }
        }

        .path {
            stroke-dasharray: 187;
            stroke-dashoffset: 0;
            transform-origin: center;
            animation: dash 1.4s ease-in-out infinite,
                colors 5.6s ease-in-out infinite;
        }

        @keyframes colors {
            0% {
                stroke: #4285f4;
            }

            25% {
                stroke: #de3e35;
            }

            50% {
                stroke: #f7c223;
            }

            75% {
                stroke: #1b9a59;
            }

            100% {
                stroke: #4285f4;
            }
        }

        @keyframes dash {
            0% {
                stroke-dashoffset: 187;
            }

            50% {
                stroke-dashoffset: 46.75;
                transform: rotate(135deg);
            }

            100% {
                stroke-dashoffset: 187;
                transform: rotate(450deg);
            }
        }

        #a2hs {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 20px;
            padding: 20px;
            display: none;
        }

        #searchBox {
            width: 100%;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #searchBox input[type=text] {
            width: 97%;
            height: 24px;
            margin: auto;
            padding: 5px;
            font-size: 18px;
            border: var(--whitesmoke) 1px solid;
            color: var(--dark);
            text-align: center;
        }

        #searchWrapper {
            width: calc(100vw - 20px);
            height: 40px;
            padding: 3px 10px;
        }

        .collapsible {
            background-color: var(--gray);
            color: var(--dark);
            cursor: pointer;
            padding: 18px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
            transition: background-color 0.2s ease-in-out;
            box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.1);
        }

        .collapsible:hover,
        .collapsible:focus,
        .content button:hover,
        .content button:focus {
            background-color: var(--accent);
        }

        .collapsible:after {
            content: '\002B';
            color: var(--dark);
            font-weight: bold;
            float: right;
            margin-left: 5px;
        }

        .active:after {
            content: "\2212";
        }

        .content {
            padding: 18px 0;
            width: 100%;
            transition: height 0.2s ease-out;
            background-color: var(--whitesmoke);
        }

        .content button {
            width: 100%;
            padding: 10px 0;
            border: none;
            background-color: var(--whitesmoke);
            box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s ease-in-out;
        }

        .content button:after {
            content: '\20D5';
            color: var(--dark);
            font-weight: bold;
            font-size: 17px;
            float: right;
            margin-right: 17px;
        }

        #backButton {
            position: absolute;
            top: 0;
            left: 0;
            font-size: 10px;
            margin-top: 20px;
            padding: 10px;
            border-radius: 0 3px 14px 0;
            background: var(--whitesmoke);
            z-index: 3;
            box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.1);
        }

        #resultsCount {
            padding: 5px 0;
            font-size: 12px;
            background: var(--whitesmoke);
            width: 100%;
            text-align: center;
            z-index: 3;
            box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.1);
        }

        #innerDetails {
            width: 95%;
            height: 95%;
            overflow: auto;
            /* border: var(--dark) 1px solid;
            border-radius: 5px;
            background: var(--gray); */
        }

        .entityTitle {
            height: 70px;
            text-align: center;
            border-bottom: var(--dark) 1px solid;
        }

        .entityTitle * {
            padding: 5px 0;
            margin: 5px 0;
        }

        .note {
            width: auto;
            margin: 20px 5px;
            max-height: 90px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
        }

        .collapsedNote::after {
            width: 100%;
            background: linear-gradient(#eee);
        }

        .noteHeader {
            padding: 5px;
            width: auto;
            height: 40px;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
        }

        .noteBody {
            width: auto;
            font-size: 12px;
            margin: 5px;
        }

        #notesTitle {
            text-align: center;
        }

        #notesInner {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <nav id="navbar">
        <h2>Gleecall</h2>
        <div id="searchWrapper">
            <form id="searchBox">
                <input type="text" name="searchTerm" id="searchTerm">
            </form>
        </div>
    </nav>
    <div id="a2hs">+</div>
    <div id="app-shell">
        <div id="screens">
            <div id="backButton" style="display: none">back</div>
            <div id="screen-search" class="screen">
                <h4>Do a search to get some results</h4>
            </div>
            <div id="screen-entity" class="screen">
                <h4>Select an Entity to view Details</h4>
            </div>
        </div>
    </div>
    <script>
        /* Helper Cookie Methods */
        function getCookie(cname) {
            var name = cname + "=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return null;
        }

        function setCookie(cookie, value, max_age, path = '/') {
            console.log('setting ' + cookie + ' to ' + value);
            document.cookie = cookie + '=' + value + '; max-age=' + max_age + '; path=' + path;
        }
        /* Initialise our tokens and check validity */
        let tokens = [getCookie('refresh_token'), getCookie('BhRestToken'), getCookie('restUrl')];
        console.log('init: ' + tokens);
        if (!tokens[0])
            login();

        if (!tokens[1]) {
            console.log('RestToken invalid refreshing');
            refresh(tokens[0]);
        }

        function refresh(refreshToken) {
            if (!tokens[0]) {
                return;
            }
            fetch('/gleecall.api/backend?refresh=' + refreshToken).then(() => {
                location.reload();
            });
        }

        function login() {
            window.open("/gleecall.api/assets/popup.html", "mywindow", "width=350,height=400");
            // Create IE + others compatible event handler
            var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
            var eventer = window[eventMethod];
            var messageEvent = eventMethod == "attachEvent" ? "onmessage" : "message";
            // Listen to message from child window
            eventer(messageEvent, function (e) {
                console.log('origin: ', e.origin)

                // Check if origin is proper
                if (e.origin != 'http://localhost') {
                    return
                }
                console.log('parent received message!: ', e.data);
                location.reload();
            }, false);
        }

        // const debounce = (func, wait, immediate) => {
        //     var timeout;
        //     return (...args) => {
        //         const later = () => {
        //             timeout = null;
        //             if (!immediate) func.apply(this, args);
        //         };
        //         const callNow = immediate && !timeout;
        //         clearTimeout(timeout);
        //         timeout = setTimeout(later, wait);
        //         if (callNow) func.apply(this, args);
        //     };
        // };
        // const screens = document.querySelector("#screens");
        // const navbar = document.querySelector("#navbar");
        // const tester = document.querySelector('#tester');

        // const pageNames = ["Search", "Rewards"];

        // const pageTransition = debounce(() => {
        //     if (Math.round(screens.scrollLeft / window.innerWidth) < 1)
        //         navbar.textContent = pageNames[0];
        // }, 60);

        // const swoop = () => {
        //     screens.scroll(1000, 0);
        //     console.log('scrolling')
        // }

        let deferredPrompt;
        const button = document.querySelector('#a2hs');
        window.addEventListener('beforeinstallprompt', event => {
            event.preventDefault();
            deferredPrompt = event;
            button.style.display = "block";
        });
        button.addEventListener('click', () => {
            button.style.display = "none";
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(result => {
                console.log(result.outcome);
                deferredPrompt = null;
            });
        });

        var inactivityTime = function () {
            console.info('timer started');

            var time;
            window.onload = resetTimer;
            // DOM Events
            document.onmousemove = resetTimer;
            document.onkeypress = resetTimer;

            function logout() {
                // alert("You are now logged out.");
                // const kill = confirm('Close Window?');


                // }
                console.error('inactivity');
                window.close();
                //location.href = 'logout.html'
            }

            function resetTimer() {
                console.info('timer reset, event captured');
                clearTimeout(time);
                time = setTimeout(logout, 30000)
                // 1000 milliseconds = 1 second
            }
        };

        inactivityTime(); 
    </script>
</body>

</html>